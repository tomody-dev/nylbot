name: nylbot-merge-action-test

# =============================================================================
# Runs unit tests for the nylbot-merge TypeScript action
# =============================================================================
# This workflow ensures that:
# 1. The TypeScript action compiles successfully
# 2. All unit tests pass
# 3. The action is ready for use
# =============================================================================

on:
  pull_request:
    paths:
      - '.github/actions/nylbot-merge/**'
      - '.github/workflows/nylbot-merge-action-test.yml'
  workflow_dispatch:

defaults:
  run:
    working-directory: .github/actions/nylbot-merge

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: '.github/actions/nylbot-merge/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Check code formatting
        run: npm run check:format

      - name: Run linter
        run: npm run check:lint

      - name: Run type checks
        run: npm run check:type

      - name: Run tests with coverage
        run: |
          set -Eeuo pipefail
          npm run check:test | tee /tmp/coverage-${{ github.run_id }}.txt

      - name: Report coverage to summary
        if: success()
        run: |
          set -Eeuo pipefail
          {
            echo "## Test Coverage Report"
            echo ""

            if [ -f /tmp/coverage-${{ github.run_id }}.txt ] && grep -q "Coverage report" /tmp/coverage-${{ github.run_id }}.txt; then
              echo '| File | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s |'
              echo '|:-----|--------:|---------:|--------:|--------:|--------------------|'
              sed -n '/^File/{n;:loop;n;/^-/q;p;b loop;}' /tmp/coverage-${{ github.run_id }}.txt
            else
              echo '_Coverage data not available_'
            fi
          } >> "$GITHUB_STEP_SUMMARY"

          rm -f /tmp/coverage-${{ github.run_id }}.txt

      - name: Bundle action
        run: npm run bundle

      - name: Verify dist is up to date
        run: |
          set -Eeuo pipefail
          # If dist/ doesn't exist after build, that's an error
          if [ ! -d "dist" ]; then
            echo "::error::dist/ directory was not created by the build. Check the build configuration."
            exit 1
          # Check if dist/ directory exists and has changes
          elif [ -n "$(git status --porcelain dist/)" ]; then
            echo "::error::dist/ directory is out of date. Run 'npm run bundle' and commit the changes."
            git diff dist/
            exit 1
          fi
